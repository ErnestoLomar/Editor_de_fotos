<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Editor de imágenes</title>
    </head>
    <body>

        <!-- Este es el botón para cargar una imagen -->
        <button id="load-image-button">Cargar imagen</button>

        <!-- Este es el botón para guardar la imagen editada -->
        <button id="save-image-button">Guardar imagen</button>

        <!-- Este es el botón para eliminar la ultima linea creada -->
        <button id="clear-last-line">Eliminar linea</button>

        <!-- Este es el botón para dibujar una linea -->
        <button id="draw-line">Dibujar linea</button>

        <!-- Este es el botón para agregar texto al canvas -->
        <button id="add-text">Agregar texto</button>

        <!-- Elemento input para ingresar el texto -->
        <input type="text" id="txtTexto" placeholder="Ingrese el texto a escribir">

        <!-- Este es el canvas donde se dibujará la imagen -->
        <canvas id="canvas" width="500" height="500" style="background-color: darkgrey;"></canvas>

        <!-- Este es el script que contiene el código JavaScript -->
        <script>
            
            // Obtenemos el canvas y el contexto de dibujo
            var canvas = document.getElementById('canvas');
            var ctx = canvas.getContext('2d');

            // Especificar el estilo del texto
            ctx.font = '24px sans-serif';

            // Especificar el color del texto
            ctx.fillStyle = '#000';

            // Obtenemos el texto ingresado
            var textoIngresado = document.getElementById('txtTexto');
            
            // Variable para almacenar la posición de inicio y final de la línea
            var previsualizando = false

            let lines = [];

            // Guarda la imagen actual del canvas en una variable
            let canvasImage;

            // Agregamos un evento al botón de carga de imágenes
            document.getElementById('load-image-button').addEventListener('click', function() {
                
                // Creamos un elemento de entrada de archivos
                var input = document.createElement('input');

                input.type = 'file';
                // Variables para almacenar la posición de inicio y final de la línea
                var x1, y1, x2, y2;

                // Bandera para indicar si se está dibujando una línea
                var dibujar = false;

                // Bandera para indicar si se está escribiendo un texto
                var addText = false;

                // Agregamos un evento al elemento de entrada de archivos
                input.addEventListener('change', function() {
                    // Obtenemos el archivo seleccionado
                    var file = input.files[0];

                    // Creamos un objeto de tipo URL que apunte al archivo
                    var url = URL.createObjectURL(file);

                    // Creamos una imagen y le asignamos la URL
                    var image = new Image();
                    image.src = url;

                    // Dibujamos la imagen en el canvas cuando esté cargada
                    image.addEventListener('load', function() {
                    ctx.drawImage(image, 0, 0, 500,500);
                    });
                });

                // Simulamos un click en el elemento de entrada de archivos para abrir el diálogo de selección de archivos
                input.click();
            });

            // Agregamos un evento al botón de guardado de imágenes
            document.getElementById('save-image-button').addEventListener('click', function() {
                // Creamos un enlace para descargar la imagen
                var link = document.createElement('a');
                link.download = 'imagen.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });

            // Agregamos un evento al botón de eliminar ultima linea dibujada
            document.getElementById('clear-last-line').addEventListener('click', function() {

                // Guardar el estado actual del canvas
                ctx.save();

                // Calcular el ancho y alto del rectángulo que incluye la línea
                var width = Math.abs(x1 - x2);
                var height = Math.abs(y1 - y2);

                // Calcular las coordenadas del punto de inicio del rectángulo
                var x = Math.min(x1, x2);
                var y = Math.min(y1, y2);

                // Borrar el rectángulo que incluye la línea
                ctx.clearRect(x, y, width, height);

                // Volver al estado anterior del canvas
                ctx.restore();
            });

            // Agregamos un evento al botón de agregar texto
            document.getElementById('add-text').addEventListener('click', function() {
                addText = true;
                dibujar = false;
            });

            // Agregamos un evento al botón dibujar linea
            document.getElementById('draw-line').addEventListener('click', function() {
                dibujar = true;
                addText = false;
                if (previsualizando){
                    previsualizando = false;
                }
            });

            // Función para manejar el evento mousedown
            function mouseDown(e) {
                
                x1 = e.pageX - canvas.offsetLeft;
                y1 = e.pageY - canvas.offsetTop;
                previsualizando = true;

                if (addText){
                    // Validar que se haya ingresado un texto
                    if (textoIngresado.value == '') {
                        alert('Debe ingresar un texto');
                        addText = false;
                    }else{
                        // Escribir el texto en el canvas
                        ctx.fillText(textoIngresado.value, x1, y1);
                        addText = false;
                        //textoIngresado.value = '';
                    }
                }
            }

            // Función para manejar el evento mouseup
            function mouseUp(e) {

                // Si no se está dibujando, no hacer nada
                if (!dibujar) return;

                // Guarda la imagen actual del canvas en la variable
                canvasImage = ctx.getImageData(0, 0, canvas.width, canvas.height);

                // Obtener las coordenadas del ratón
                x2 = e.pageX - canvas.offsetLeft;
                y2 = e.pageY - canvas.offsetTop;

                // Dibujar la línea
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();

                // Agrega la línea a la lista
                lines.push({ startX: x1, startY: y1, endX: x2, endY: y2 });
                
                // Limpia el canvas
                //ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Dibuja todas las líneas en el canvas
                for (let line of lines) {
                    ctx.beginPath();
                    ctx.moveTo(line.startX, line.startY);
                    ctx.lineTo(line.endX, line.endY);
                    ctx.stroke();
                }

                // Establecer la bandera como falsa
                dibujar = false;
                addText = false;
                previsualizando = false;
                lastMousePosition = null;
                // Dibuja la imagen actual del canvas
                ctx.drawImage(canvasImage, 0, 0);
            }

            // Asignar las funciones como manejadores de eventos
            canvas.addEventListener('mousedown', mouseDown);
            canvas.addEventListener('mouseup', mouseUp);

            // Función para manejar el evento mousemove
            canvas.addEventListener('mousemove', (event) => {
                // Si no se está dibujando, no hacer nada
                if (!dibujar) return;
                    
                if (previsualizando){
                    
                    // Dibuja la imagen actual del canvas
                    ctx.drawImage(canvasImage, 0, 0);

                    endX = event.offsetX;
                    endY = event.offsetY;

                    // Limpia el canvas para eliminar la línea anterior
                    //ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // Dibuja la línea en el canvas
                    ctx.beginPath();
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(endX, endY);
                    ctx.stroke();

                }
            });

            canvas.addEventListener('mouseleave', () => {
                // Establecer la bandera como falsa
                dibujar = false;
                addText = false;
                previsualizando = false;
            });

        </script>
    </body>
</html>