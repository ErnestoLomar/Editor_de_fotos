<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Editor de imágenes</title>
    </head>
    <body>

        <!-- Este es el botón para cargar una imagen -->
        <button id="load-image-button" style="background-color: #E5E5E5; color: #000;">Cargar imagen</button>

        <!-- Este es el botón para guardar la imagen editada -->
        <button id="save-image-button" style="background-color: #E5E5E5; color: #000;">Guardar imagen</button>

        <!-- Este es el botón para dibujar una linea -->
        <button id="draw-line" style="background-color: #E5E5E5; color: #000;">Dibujar linea</button>

        <!-- Este es el botón para eliminar la ultima linea creada -->
        <button id="clear-last-line" style="background-color: #E5E5E5; color: #000;">Eliminar linea</button>

        <!-- Este es el botón para agregar texto al canvas -->
        <button id="add-text" style="background-color: #E5E5E5; color: #000;">Agregar texto</button>

        <!-- Este es el botón para editar la posición de un texto-->
        <button id="edit-text" style="background-color: #E5E5E5; color: #000;">Editar posición de texto</button>

        <!-- Elemento input para ingresar el texto -->
        <input type="text" id="txtTexto" placeholder="Ingrese el texto a escribir" style="position: absolute; display: none;">

        <!-- Elemento color para ingresar color de texto-->
        <input type="color" id="colorTexto" name="colorTexto">

        <!-- Elemento de fuentes posibles-->
        <select id="fuentes">
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
            <option value="12">12</option>
            <option value="14">14</option>
            <option value="16">16</option>
            <option value="18">18</option>
            <option value="20">20</option>
            <option value="22">22</option>
            <option value="24">24</option>
            <option value="26">26</option>
            <option value="28">28</option>
            <option value="36">36</option>
        </select>

        <!-- Este es el botón para iniciar la goma -->
        <button id="goma" style="background-color: #E5E5E5; color: #000;">Goma de textos</button>

        <!-- Este es el botón para iniciar la barita mágica -->
        <button id="baritaMagica" style="background-color: #E5E5E5; color: #000;">Barita Mágica</button>

        <!-- Este es el botón para deshacer cambios de la barita mágica -->
        <button id="deshacerCambios" style="background-color: #E5E5E5; color: #000;">Deshacer cambios</button>

        <!-- Este es el botón para iniciar la goma -->
        <button id="urlImagen" style="background-color: #E5E5E5; color: #000;">Url Imagen</button>

        <br>
        <p id="estado">Escoja una opción</p>
        <br>

        <!-- Este es el contenedor donde se dibujara el canvas -->
        <div id="canvas-container" style="background-color: white;"></div>

        <style>
            .erasing {
                cursor: url(goma-de-borrar.png), auto;
            }
        </style>

        <!-- Este es el script que contiene el código JavaScript -->
        <script>

            // Obtenemos el contenedor del canvas
            var container = document.getElementById("canvas-container");
            
            // Obtenemos el canvas y el contexto de dibujo
            var canvas = document.createElement('canvas');

            canvas.id = "canvas";

            //var canvas = document.getElementById('canvas');
            var ctx = canvas.getContext('2d');

            // Obtenemos el texto ingresado
            var textoIngresado = document.getElementById('txtTexto');

            // Obtenemos el texto del estado
            var textoEstado = document.getElementById('estado');
            
            // Variable para almacenar la posición de inicio y final de la línea
            var previsualizando = false;

            // Lista de lineas creadas
            var lines = [];

            // Lista de textos creados
            var textos = [];
            var contadorDeTextos = 0;

            var usandoGoma = false;

            var usandoBaritaMagica = false;

            var mousePresionado = false;

            // Creamos una imagen 
            var image = new Image();

            // Variables para almacenar la posición de inicio y final de la línea
            var x1, y1, x2, y2;

            // Bandera para indicar si se está dibujando una línea
            var dibujar = false;

            // Bandera para indicar si se está escribiendo un texto
            var addText = false;

            // Bandera para indicar si se va a arrastrar un texto o no
            var textoArrastrado = false;
            var editarTextos = false;
            var xInicial, yInicial;
            var textoAArrastrar = null;
            var backupImage = null;

            // Guardamos el color elegido
            const colorElegido = document.getElementById('colorTexto');

            // Combobox para escoger una fuente
            const combobox = document.getElementById("fuentes");

            // Encontramos si una cantidad se encuentra dentro de un rango
            const estaEnRango = (cantidad, minimo, maximo) => (cantidad - minimo) / (maximo - minimo);

            // Obtenemos la fuente escogida
            var fuenteEscogida = "8";
            
            // Función para guardar la fuente del texto
            combobox.addEventListener("change", function() {
                fuenteEscogida = combobox.value;
            });

            // Agregamos un evento al botón de carga de imágenes
            document.getElementById('load-image-button').addEventListener('click', function() {
                
                // Creamos un elemento de entrada de archivos
                var input = document.createElement('input');

                input.type = 'file';

                if (container.children.length == 0) {
                    container.appendChild(canvas);
                }

                // Agregamos un evento al elemento de entrada de archivos
                input.addEventListener('change', function() {
                    
                    // Obtenemos el archivo seleccionado
                    var file = input.files[0];

                    // Creamos un objeto de tipo URL que apunte al archivo
                    var url = URL.createObjectURL(file);

                    // Le asignamos la URL
                    image.src = url;

                    image.addEventListener('load', function() {
                        canvas.width = image.width + 80;
                        canvas.height = image.height + 80;
                        //ctx.fillStyle = "red";
                        //ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(image, 0, 0);
                        backupImage = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        textos = [];
                        lines = [];
                    });

                    textoEstado.innerHTML = "Imagen cargada"

                });

                // Simulamos un click en el elemento de entrada de archivos para abrir el diálogo de selección de archivos
                input.click();
                document.getElementById('draw-line').style.backgroundColor = "#E5E5E5";
                document.getElementById('draw-line').style.color = "#000";
                document.getElementById('add-text').style.backgroundColor = "#E5E5E5";
                document.getElementById('add-text').style.color = "#000";
                document.getElementById('edit-text').style.backgroundColor = "#E5E5E5";
                document.getElementById('edit-text').style.color = "#000";
                document.getElementById('goma').style.backgroundColor = "#E5E5E5";
                document.getElementById('goma').style.color = "#000";
                document.getElementById('baritaMagica').style.backgroundColor = "#E5E5E5";
                document.getElementById('baritaMagica').style.color = "#000";
                // Establecer la bandera como falsa
                dibujar = false;
                addText = false; //
                previsualizando = false;
                usandoGoma = false;
                editarTextos = false;
                usandoBaritaMagica = false;
            });

            document.getElementById("edit-text").onclick = function() {
                if (!editarTextos){
                    document.getElementById('draw-line').style.backgroundColor = "#E5E5E5";
                    document.getElementById('draw-line').style.color = "#000";
                    document.getElementById('add-text').style.backgroundColor = "#E5E5E5";
                    document.getElementById('add-text').style.color = "#000";
                    document.getElementById('edit-text').style.backgroundColor = "#7D3C98";
                    document.getElementById('edit-text').style.color = "#fff";
                    document.getElementById('goma').style.backgroundColor = "#E5E5E5";
                    document.getElementById('goma').style.color = "#000";
                    document.getElementById('baritaMagica').style.backgroundColor = "#E5E5E5";
                    document.getElementById('baritaMagica').style.color = "#000";
                    // Establecer la bandera como falsa
                    dibujar = false;
                    addText = false; //
                    previsualizando = false;
                    usandoGoma = false;
                    usandoBaritaMagica = false;
                    editarTextos = true;
                }else if (editarTextos){
                    document.getElementById('draw-line').style.backgroundColor = "#E5E5E5";
                    document.getElementById('draw-line').style.color = "#000";
                    document.getElementById('add-text').style.backgroundColor = "#E5E5E5";
                    document.getElementById('add-text').style.color = "#000";
                    document.getElementById('edit-text').style.backgroundColor = "#E5E5E5";
                    document.getElementById('edit-text').style.color = "#000";
                    document.getElementById('goma').style.backgroundColor = "#E5E5E5";
                    document.getElementById('goma').style.color = "#000";
                    document.getElementById('baritaMagica').style.backgroundColor = "#E5E5E5";
                    document.getElementById('baritaMagica').style.color = "#000";
                    // Establecer la bandera como falsa
                    dibujar = false;
                    addText = false; //
                    previsualizando = false;
                    usandoGoma = false;
                    usandoBaritaMagica = false;
                    editarTextos = false;
                }
            };

            document.getElementById("urlImagen").onclick = function() {
                image.src = 'img1.jpg';
                image.addEventListener('load', function() {
                    canvas.width = image.width + 80;
                    canvas.height = image.height + 80;
                    //ctx.fillStyle = "red";
                    //ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(image, 0, 0);
                    backupImage = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    textos = [];
                    lines = [];
                });
                if (container.children.length == 0) {
                    container.appendChild(canvas);
                }
            };

            // Agregamos un evento al botón de guardado de imágenes
            document.getElementById('save-image-button').addEventListener('click', function() {
                // Creamos un enlace para descargar la imagen
                var link = document.createElement('a');
                link.download = 'imagen.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
                textoEstado.innerHTML = "Imagen guardada"
                document.getElementById('draw-line').style.backgroundColor = "#E5E5E5";
                document.getElementById('draw-line').style.color = "#000";
                document.getElementById('add-text').style.backgroundColor = "#E5E5E5";
                document.getElementById('add-text').style.color = "#000";
                document.getElementById('edit-text').style.backgroundColor = "#E5E5E5";
                document.getElementById('edit-text').style.color = "#000";
                document.getElementById('goma').style.backgroundColor = "#E5E5E5";
                document.getElementById('goma').style.color = "#000";
                document.getElementById('baritaMagica').style.backgroundColor = "#E5E5E5";
                document.getElementById('baritaMagica').style.color = "#000";
                // Establecer la bandera como falsa
                dibujar = false;
                addText = false; //
                previsualizando = false;
                usandoGoma = false;
                usandoBaritaMagica = false;
                editarTextos = false;
            });

            // Agregamos un evento al botón de eliminar ultima linea dibujada
            document.getElementById('clear-last-line').addEventListener('click', function() {

                if (lines.length > 0){
                    // Eliminamos el ultimo elemento 
                    lines.pop()

                    // Eliminamos el canvas
                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    // Agregamos el color de fondo del canvas
                    //ctx.fillStyle = "red";
                    //ctx.fillRect(0, 0, canvas.width, canvas.height);

                    // Dibujamos la imagen
                    //ctx.drawImage(backupImage, 0, 0);
                    ctx.putImageData(backupImage, 0, 0);

                    // Dibuja todas las líneas en el canvas
                    for (let line of lines) {
                        ctx.beginPath();
                        ctx.moveTo(line.startX, line.startY);
                        ctx.lineTo(line.endX, line.endY);
                        ctx.stroke();
                    }

                    // Dibuja todas los textos en el canvas
                    for (let text of textos) {
                        // Especificar el color del texto
                        ctx.fillStyle = text.color;
                        // Especificar la fuente del texto
                        ctx.font = `${text.fuente}px sans-serif`;
                        // Especificar el texto
                        ctx.fillText(text.texto, text.startX, text.startY);
                    }

                    textoEstado.innerHTML = "Ultima linea eliminada"
                }

                // Establecer la bandera como falsa
                dibujar = false;
                addText = false; //
                previsualizando = false;
                usandoGoma = false;
                usandoBaritaMagica = false;
                editarTextos = false;
                document.getElementById('draw-line').style.backgroundColor = "#E5E5E5";
                document.getElementById('draw-line').style.color = "#000";
                document.getElementById('add-text').style.backgroundColor = "#E5E5E5";
                document.getElementById('add-text').style.color = "#000";
                document.getElementById('edit-text').style.backgroundColor = "#E5E5E5";
                document.getElementById('edit-text').style.color = "#000";
                document.getElementById('goma').style.backgroundColor = "#E5E5E5";
                document.getElementById('goma').style.color = "#000";
                document.getElementById('baritaMagica').style.backgroundColor = "#E5E5E5";
                document.getElementById('baritaMagica').style.color = "#000";

            });

            // Agregamos un evento al botón de agregar texto
            document.getElementById('add-text').addEventListener('click', function() {
                if (!addText){
                    addText = true;
                    dibujar = false;
                    previsualizando = false;
                    usandoGoma = false;
                    usandoBaritaMagica = false;
                    editarTextos = false;
                    document.getElementById('add-text').style.backgroundColor = "#7D3C98";
                    document.getElementById('add-text').style.color = "#fff";
                    document.getElementById('edit-text').style.backgroundColor = "#E5E5E5";
                    document.getElementById('edit-text').style.color = "#000";
                    document.getElementById('draw-line').style.backgroundColor = "#E5E5E5";
                    document.getElementById('draw-line').style.color = "#000";
                    document.getElementById('goma').style.backgroundColor = "#E5E5E5";
                    document.getElementById('goma').style.color = "#000";
                    document.getElementById('baritaMagica').style.backgroundColor = "#E5E5E5";
                    document.getElementById('baritaMagica').style.color = "#000";
                }else if (addText){
                    addText = false;
                    dibujar = false;
                    previsualizando = false;
                    usandoGoma = false;
                    usandoBaritaMagica = false;
                    editarTextos = false;
                    document.getElementById('add-text').style.backgroundColor = "#E5E5E5";
                    document.getElementById('add-text').style.color = "#000";
                    document.getElementById('edit-text').style.backgroundColor = "#E5E5E5";
                    document.getElementById('edit-text').style.color = "#000";
                    document.getElementById('draw-line').style.backgroundColor = "#E5E5E5";
                    document.getElementById('draw-line').style.color = "#000";
                    document.getElementById('goma').style.backgroundColor = "#E5E5E5";
                    document.getElementById('goma').style.color = "#000";
                    document.getElementById('baritaMagica').style.backgroundColor = "#E5E5E5";
                    document.getElementById('baritaMagica').style.color = "#000";
                }
            });

            // Agregamos un evento al botón dibujar linea
            document.getElementById('draw-line').addEventListener('click', function() {
                if (!dibujar){
                    dibujar = true;
                    addText = false;
                    usandoGoma = false;
                    editarTextos = false;
                    usandoBaritaMagica = false;
                    document.getElementById('draw-line').style.backgroundColor = "#7D3C98";
                    document.getElementById('draw-line').style.color = "#fff";
                    document.getElementById('add-text').style.backgroundColor = "#E5E5E5";
                    document.getElementById('add-text').style.color = "#000";
                    document.getElementById('edit-text').style.backgroundColor = "#E5E5E5";
                    document.getElementById('edit-text').style.color = "#000";
                    document.getElementById('goma').style.backgroundColor = "#E5E5E5";
                    document.getElementById('goma').style.color = "#000";
                    document.getElementById('baritaMagica').style.backgroundColor = "#E5E5E5";
                    document.getElementById('baritaMagica').style.color = "#000";
                }else if (dibujar){
                    dibujar = false;
                    addText = false;
                    usandoGoma = false;
                    usandoBaritaMagica = false;
                    editarTextos = false;
                    document.getElementById('draw-line').style.backgroundColor = "#E5E5E5";
                    document.getElementById('draw-line').style.color = "#000";
                    document.getElementById('add-text').style.backgroundColor = "#E5E5E5";
                    document.getElementById('add-text').style.color = "#000";
                    document.getElementById('edit-text').style.backgroundColor = "#E5E5E5";
                    document.getElementById('edit-text').style.color = "#000";
                    document.getElementById('goma').style.backgroundColor = "#E5E5E5";
                    document.getElementById('goma').style.color = "#000";
                    document.getElementById('baritaMagica').style.backgroundColor = "#E5E5E5";
                    document.getElementById('baritaMagica').style.color = "#000";
                }
                if (previsualizando){
                    previsualizando = false;
                }
            });

            // Agregamos un evento al botón goma
            document.getElementById('goma').addEventListener('click', function() {
                if (!usandoGoma){
                    usandoGoma = true;
                    usandoBaritaMagica = false;
                    dibujar = false;
                    addText = false; //
                    previsualizando = false;
                    editarTextos = false;
                    document.getElementById('goma').style.backgroundColor = "#7D3C98";
                    document.getElementById('goma').style.color = "#fff";
                    document.getElementById('baritaMagica').style.backgroundColor = "#E5E5E5";
                    document.getElementById('baritaMagica').style.color = "#000";
                    document.getElementById('draw-line').style.backgroundColor = "#E5E5E5";
                    document.getElementById('draw-line').style.color = "#000";
                    document.getElementById('add-text').style.backgroundColor = "#E5E5E5";
                    document.getElementById('add-text').style.color = "#000";
                    document.getElementById('edit-text').style.backgroundColor = "#E5E5E5";
                    document.getElementById('edit-text').style.color = "#000";
                }else if (usandoGoma){
                    usandoGoma = false;
                    usandoBaritaMagica = false;
                    dibujar = false;
                    addText = false;
                    previsualizando = false;
                    editarTextos = false;
                    document.getElementById('goma').style.backgroundColor = "#E5E5E5";
                    document.getElementById('goma').style.color = "#000";
                    document.getElementById('baritaMagica').style.backgroundColor = "#E5E5E5";
                    document.getElementById('baritaMagica').style.color = "#000";
                    document.getElementById('draw-line').style.backgroundColor = "#E5E5E5";
                    document.getElementById('draw-line').style.color = "#000";
                    document.getElementById('add-text').style.backgroundColor = "#E5E5E5";
                    document.getElementById('add-text').style.color = "#000";
                    document.getElementById('edit-text').style.backgroundColor = "#E5E5E5";
                    document.getElementById('edit-text').style.color = "#000";
                }
            });


            // Agregamos un evento al botón barita magica
            document.getElementById('baritaMagica').addEventListener('click', function() {
                if (!usandoBaritaMagica){
                    canvas.classList.add("erasing");
                    usandoGoma = false;
                    usandoBaritaMagica = true;
                    dibujar = false;
                    addText = false; //
                    previsualizando = false;
                    editarTextos = false;
                    document.getElementById('baritaMagica').style.backgroundColor = "#7D3C98";
                    document.getElementById('baritaMagica').style.color = "#fff";
                    document.getElementById('goma').style.backgroundColor = "#E5E5E5";
                    document.getElementById('goma').style.color = "#000";
                    document.getElementById('draw-line').style.backgroundColor = "#E5E5E5";
                    document.getElementById('draw-line').style.color = "#000";
                    document.getElementById('add-text').style.backgroundColor = "#E5E5E5";
                    document.getElementById('add-text').style.color = "#000";
                    document.getElementById('edit-text').style.backgroundColor = "#E5E5E5";
                    document.getElementById('edit-text').style.color = "#000";
                }else if (usandoBaritaMagica){
                    canvas.classList.remove("erasing");
                    usandoGoma = false;
                    usandoBaritaMagica = false;
                    dibujar = false;
                    addText = false;
                    previsualizando = false;
                    editarTextos = false;
                    document.getElementById('baritaMagica').style.backgroundColor = "#E5E5E5";
                    document.getElementById('baritaMagica').style.color = "#000";
                    document.getElementById('goma').style.backgroundColor = "#E5E5E5";
                    document.getElementById('goma').style.color = "#000";
                    document.getElementById('draw-line').style.backgroundColor = "#E5E5E5";
                    document.getElementById('draw-line').style.color = "#000";
                    document.getElementById('add-text').style.backgroundColor = "#E5E5E5";
                    document.getElementById('add-text').style.color = "#000";
                    document.getElementById('edit-text').style.backgroundColor = "#E5E5E5";
                    document.getElementById('edit-text').style.color = "#000";
                }
            });

            document.getElementById('deshacerCambios').addEventListener('click', function() {
                ctx.putImageData(backupImage, 0, 0);
                image = ctx.getImageData(0, 0, canvas.width, canvas.height);    
                document.getElementById('baritaMagica').style.backgroundColor = "#E5E5E5";
                document.getElementById('baritaMagica').style.color = "#000";
                document.getElementById('goma').style.backgroundColor = "#E5E5E5";
                document.getElementById('goma').style.color = "#000";
                document.getElementById('draw-line').style.backgroundColor = "#E5E5E5";
                document.getElementById('draw-line').style.color = "#000";
                document.getElementById('add-text').style.backgroundColor = "#E5E5E5";
                document.getElementById('add-text').style.color = "#000";
                document.getElementById('edit-text').style.backgroundColor = "#E5E5E5";
                document.getElementById('edit-text').style.color = "#000";
            });

            // Función para manejar el evento mousedown
            function mouseDown(e) {
                
                x1 = e.pageX - canvas.offsetLeft;
                y1 = e.pageY - canvas.offsetTop;
                previsualizando = true;

                if (addText){

                    //  
                    textoIngresado.style.left = x1 + "px";

                    // 
                    textoIngresado.style.top = y1 + 100 + "px";

                    // 
                    textoIngresado.style.display = "block";

                    textoEstado.innerHTML = "Agregando texto"

                    textoIngresado.value = '';
                    
                }else  if (usandoGoma) {
                    // Recorremos todos los textos
                    for (let text of textos) {
                        // Verificamos si el texto a borrar coincide con alguna de las coordenadas de los textos
                        if (estaEnRango(y1, (text.startY), (text.startY - 15)) >= 0 && estaEnRango(y1, (text.startY), (text.startY - 15)) <= 1) {
                            if (estaEnRango(x1, (text.startX), (text.startX + 80)) >= 0 && estaEnRango(x1, (text.startX ), (text.startX + 80)) <= 1) {
                                const indice = textos.indexOf(text)
                                textos.splice(indice, 1);
                            }
                        }

                        // Eliminamos el canvas
                        ctx.clearRect(0, 0, canvas.width, canvas.height);

                        // Agregamos el color de fondo del canvas
                        //ctx.fillStyle = "red";
                        //ctx.fillRect(0, 0, canvas.width, canvas.height);

                        // Dibujamos la imagen
                        //ctx.drawImage(backupImage, 0, 0);
                        ctx.putImageData(backupImage, 0, 0);

                        // Dibuja todas las líneas en el canvas
                        for (let line of lines) {
                            ctx.beginPath();
                            ctx.moveTo(line.startX, line.startY);
                            ctx.lineTo(line.endX, line.endY);
                            ctx.stroke();
                        }

                        // Dibuja todas los textos en el canvas
                        for (let text of textos) {
                            // Especificar el color del texto
                            ctx.fillStyle = text.color;
                            // Especificar el tamaño de la fuente
                            ctx.font = `${text.fuente}px sans-serif`;
                            // Escribir el texto
                            ctx.fillText(text.texto, text.startX, text.startY);
                        }
                    }
                }else if (editarTextos){
                    // Recorremos todos los textos
                    for (let text of textos) {
                        // Verificamos si el texto a borrar coincide con alguna de las coordenadas de los textos
                        if (estaEnRango(y1, (text.startY), (text.startY - 15)) >= 0 && estaEnRango(y1, (text.startY), (text.startY - 15)) <= 1) {
                            if (estaEnRango(x1, (text.startX), (text.startX + 80)) >= 0 && estaEnRango(x1, (text.startX ), (text.startX + 80)) <= 1) {
                                textoArrastrado = true;
                                xInicial = x1;
                                yInicial = y1;
                                textoAArrastrar = text;
                            }
                        }
                    }
                }else if (usandoBaritaMagica){
                    backupImage = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    ctx.clearRect(x1, y1, 10, 10);
                    ctx.fillStyle = "white";
                    ctx.fillRect(x1, y1, 10, 10);
                    mousePresionado = true;
                }
            }

            // Función para manejar el evento mousemove
            canvas.addEventListener('mousemove', (event) => {

                if (textoArrastrado) {

                    endX = event.offsetX;
                    endY = event.offsetY;

                    // Limpia el canvas para eliminar la línea anterior
                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    // Agregamos el color de fondo del canvas
                    //ctx.fillStyle = "red";
                    //ctx.fillRect(0, 0, canvas.width, canvas.height);

                    //ctx.drawImage(backupImage, 40, 40);

                    ctx.putImageData(backupImage, 0, 0);
                    //image = ctx.getImageData(0, 0, canvas.width, canvas.height);  

                    // Dibuja todas las líneas en el canvas
                    for (let line of lines) {
                        ctx.beginPath();
                        ctx.moveTo(line.startX, line.startY);
                        ctx.lineTo(line.endX, line.endY);
                        ctx.stroke();
                    }

                    // Dibuja todas los textos en el canvas
                    for (let text of textos) {
                        if(textoAArrastrar.id != text.id){
                            // Especificar el color del texto
                            ctx.fillStyle = text.color;
                            // Especificamos el tamaño de fuente
                            ctx.font = `${text.fuente}px sans-serif`;
                            // Escribir el texto
                            ctx.fillText(text.texto, text.startX, text.startY);
                        }
                    }

                    var xArrastrado = event.clientX - canvas.offsetLeft;
                    var yArrastrado = event.clientY - canvas.offsetTop;
    
                    var dx = xArrastrado - xInicial;
                    var dy = yArrastrado - yInicial;
                    
                    ctx.fillStyle = textoAArrastrar.color;
                    ctx.font = `${textoAArrastrar.fuente}px sans-serif`;
                    ctx.fillText(textoAArrastrar.texto, xInicial + dx, yInicial + dy);
                    textoAArrastrar.startX = xInicial + dx;
                    textoAArrastrar.startY = yInicial + dy;

                    for (let text of textos) {
                        if (text.id == textoAArrastrar.id){
                            text.startX = textoAArrastrar.startX;
                            text.startY = textoAArrastrar.startY;
                        }
                    }
                    
                }

                if (usandoBaritaMagica && mousePresionado){

                    xBorrar = event.pageX - canvas.offsetLeft;
                    yBorrar = event.pageY - canvas.offsetTop;
                    ctx.clearRect(xBorrar, yBorrar, 10, 10);
                    ctx.fillStyle = "white";
                    ctx.fillRect(xBorrar, yBorrar, 10, 10);
                    backupImage = ctx.getImageData(0, 0, canvas.width, canvas.height);
                }

                // Si no se está dibujando, no hacer nada
                if (!dibujar) return;

                // Reiniciamos los valores por defecto del input text
                textoIngresado.value = '';
                textoIngresado.style.position = "absolute"; 
                textoIngresado.style.display = "none";
                    
                if (previsualizando){

                    endX = event.offsetX;
                    endY = event.offsetY;

                    // Limpia el canvas para eliminar la línea anterior
                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    // Agregamos el color de fondo del canvas
                    //ctx.fillStyle = "red";
                    //ctx.fillRect(0, 0, canvas.width, canvas.height);

                    //ctx.drawImage(backupImage, 40, 40);
                    ctx.putImageData(backupImage, 0, 0);

                    // Dibuja todas las líneas en el canvas
                    for (let line of lines) {
                        ctx.beginPath();
                        ctx.moveTo(line.startX, line.startY);
                        ctx.lineTo(line.endX, line.endY);
                        ctx.stroke();
                    }

                    // Dibuja todas los textos en el canvas
                    for (let text of textos) {
                        // Especificar el color del texto
                        ctx.fillStyle = text.color;
                        // Especificamos el tamaño de fuente
                        ctx.font = `${text.fuente}px sans-serif`;
                        // Escribir el texto
                        ctx.fillText(text.texto, text.startX, text.startY);
                    }
                    
                    // Dibuja la línea en el canvas
                    ctx.beginPath();
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(endX, endY);
                    ctx.stroke();

                }
            });

            // Función para manejar el evento mouseup
            function mouseUp(e) {

                textoArrastrado = false;
                mousePresionado = false;

                // Si no se está dibujando, no hacer nada
                if (!dibujar) return;

                // Obtener las coordenadas del ratón
                x2 = e.pageX - canvas.offsetLeft;
                y2 = e.pageY - canvas.offsetTop;

                // Dibujar la línea
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();

                // Agrega la línea a la lista
                lines.push({ startX: x1, startY: y1, endX: x2, endY: y2 });
                
                // Limpia el canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Agregamos el color de fondo del canvas
                //ctx.fillStyle = "red";
                //ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Dibujamos la imagen
                //ctx.drawImage(backupImage, 40, 40);
                ctx.putImageData(backupImage, 0, 0);
                
                // Dibuja todas las líneas en el canvas
                for (let line of lines) {
                    ctx.beginPath();
                    ctx.moveTo(line.startX, line.startY);
                    ctx.lineTo(line.endX, line.endY);
                    ctx.stroke();
                }

                // Dibuja todas los textos en el canvas
                for (let text of textos) {
                    // Especificar el color del texto
                    ctx.fillStyle = text.color;
                    // Especificar el tamaño de la fuente
                    ctx.font = `${text.fuente}px sans-serif`;
                    // Escribir el texto
                    ctx.fillText(text.texto, text.startX, text.startY);
                }

                previsualizando = false;

            }

            // Asignar las funciones como manejadores de eventos
            canvas.addEventListener('mousedown', mouseDown);
            canvas.addEventListener('mouseup', mouseUp);

            /*
            canvas.addEventListener('mouseleave', () => {
                // Establecer la bandera como falsa
                dibujar = false;
                //addText = false; //
                previsualizando = false;
            });*/

            document.addEventListener("keydown", function(event) {
                if (event.keyCode === 13) {
                    if (addText){
                        
                        // Especificar el color del texto
                        ctx.fillStyle = colorElegido.value.toString();

                        // Especificamos el tamaño de fuente
                        ctx.font = `${fuenteEscogida}px sans-serif`;

                        // Agrega el texto a la lista
                        textos.push({ startX: x1, startY: y1, texto: textoIngresado.value, color: colorElegido.value.toString(), fuente: fuenteEscogida, id: contadorDeTextos+=1});
                        
                        // Mostramos un texto en el canvas
                        ctx.fillText(textoIngresado.value, x1, y1);
                        
                        // Reiniciamos los valores por defecto
                        textoIngresado.style.position = "absolute"; 
                        textoIngresado.style.display = "none";
                    }
                }
            });           

        </script>
    </body>
</html>